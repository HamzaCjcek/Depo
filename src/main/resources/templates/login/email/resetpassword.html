<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" th:href="@{/login/email_css/css/style.css}">
    <style>
        /* Mesajın stilini ayarla */
        .message {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Şifre şartları stilini ayarla */
        .password-requirements {
            margin-bottom: 20px;
        }
        .password-requirements ul {
            list-style-type: none;
            padding: 0;
        }
        .password-requirements li {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .password-requirements li.valid {
            color: green;
        }
        .password-requirements li.invalid {
            color: red;
        }

        /* Açılıp kapanan detay özeti stili */
        details {
            margin-bottom: 20px;
        }
        summary {
            cursor: pointer;
            font-weight: bold;
            color: #155724;
        }
        summary:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<section>
    <form action="/req/reset-password" method="post" onsubmit="handleFormSubmit(event)">
        <h1>Reset Password</h1>

        <!-- Açılıp kapanan şifre şartları -->
        <details class="password-requirements">
            <summary>Şifre şartlarını göster</summary>
            <p>Şifreniz aşağıdaki şartları karşılamalıdır:</p>
            <ul>
                <li id="length">En az 8 karakter uzunluğunda olmalı</li>
                <li id="uppercase">En az bir büyük harf içermeli</li>
                <li id="lowercase">En az bir küçük harf içermeli</li>
                <li id="number">En az bir sayı içermeli</li>
                <li id="special">En az bir özel karakter içermeli (örneğin: !@#$%^&*)</li>
            </ul>
        </details>

        <!-- Display success and error messages -->
        <div class="dialog-row">
            <!-- Success message -->
            <label th:if="${successMessage}" th:text="${successMessage}" class="text-center greenText"></label>

            <!-- Error message -->
            <label th:if="${errorMessage}" th:text="${errorMessage}" class="text-center redText"></label>
        </div>

        <!-- New Password Input -->
        <div class="inputbox">
            <ion-icon name="lock-closed-outline"></ion-icon>
            <input type="password" name="newPassword" id="newPassword" required placeholder=" " oninput="validatePassword()">
            <label for="newPassword">New Password</label>
        </div>

        <!-- Confirm Password Input -->
        <div class="inputbox">
            <ion-icon name="lock-closed-outline"></ion-icon>
            <input type="password" name="confirmPassword" id="confirmPassword" required placeholder=" ">
            <label for="confirmPassword">Confirm Password</label>
        </div>

        <!-- Submit Button -->
        <button type="submit">Change Password</button>

        <!-- Back to Login Link -->
        <div class="register">
            <p>Remembered your password? <a th:href="@{/req/login}">Log In</a></p>
        </div>
    </form>

    <script>
        function validatePassword() {
            const password = document.getElementById("newPassword").value;

            // Şifre şartlarını kontrol et
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*]/.test(password);

            // Şartları güncelle
            document.getElementById("length").classList.toggle("valid", hasLength);
            document.getElementById("uppercase").classList.toggle("valid", hasUppercase);
            document.getElementById("lowercase").classList.toggle("valid", hasLowercase);
            document.getElementById("number").classList.toggle("valid", hasNumber);
            document.getElementById("special").classList.toggle("valid", hasSpecial);
        }

        function handleFormSubmit(event) {
            event.preventDefault(); // Formun otomatik gönderilmesini engelle

            const password = document.getElementById("newPassword").value;

            // Şifre şartlarını kontrol et
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*]/.test(password);

            if (!hasLength || !hasUppercase || !hasLowercase || !hasNumber || !hasSpecial) {
                alert("Şifre belirtilen şartları karşılamıyor!");
                return;
            }

            // Formu manuel olarak gönder
            const form = event.target;
            const formData = new FormData(form);

            // Mesajı göster
            const messageDiv = document.createElement("div");
            messageDiv.className = "message success";
            messageDiv.innerText = "İşlem gerçekleştiriliyor, lütfen bekleyin...";

            // Mesajı butonun hemen üstüne ekle
            const button = form.querySelector("button[type='submit']");
            form.insertBefore(messageDiv, button);

            // Formu gönder
            fetch(form.action, {
                method: form.method,
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Başarılı mesajını güncelle
                        messageDiv.innerText = data.message + " 5 saniye içinde giriş sayfasına yönlendirileceksiniz...";

                        // 5 saniye bekleyip yönlendirme yap
                        setTimeout(() => {
                            window.location.href = "/req/login"; // Yönlendirme yapılacak sayfa
                        }, 5000); // 5000 milisaniye = 5 saniye
                    } else {
                        // Hata mesajını göster
                        messageDiv.className = "message error";
                        messageDiv.innerText = data.message || "Bir hata oluştu!";
                    }
                })
                .catch(error => {
                    console.error("Hata:", error);
                    messageDiv.className = "message error";
                    messageDiv.innerText = "Bir hata oluştu!";
                });
        }
    </script>
</section>
</body>
</html>